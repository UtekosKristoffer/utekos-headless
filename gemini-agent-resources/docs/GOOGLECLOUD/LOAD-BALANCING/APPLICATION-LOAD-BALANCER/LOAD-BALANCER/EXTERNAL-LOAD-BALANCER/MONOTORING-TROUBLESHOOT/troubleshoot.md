Of course. Here is the provided text formatted as structured markdown.

# Troubleshoot issues with external Application Load Balancers

This guide describes how to troubleshoot configuration issues for external
Application Load Balancers. Before investigating, familiarize yourself with:

- [External Application Load Balancer overview](https://cloud.google.com/load-balancing/docs/l7-external/l7-xlb-overview)
- [Global and Classic Application Load Balancer logging and monitoring](https://cloud.google.com/load-balancing/docs/l7-external/logging-monitoring)
- [Regional external Application Load Balancer logging and monitoring](https://cloud.google.com/load-balancing/docs/l7-external-regional/logging-monitoring)

---

## Troubleshoot common issues with Network Analyzer

Network Analyzer automatically monitors your VPC network configuration and
detects misconfigurations. To learn about misconfiguration scenarios detected by
Network Analyzer, see
[Load balancer insights](https://cloud.google.com/network-intelligence-center/docs/network-analyzer/gcloud-cli#load-balancer-insights)
in the Network Analyzer documentation.

[Go to Network Analyzer](https://console.cloud.google.com/network-intelligence/analyzer/home)

---

## Backends have incompatible balancing modes

When creating a load balancer, you might see this error:

> `Validation failed for instance group INSTANCE_GROUP: backend services 1 and 2 point to the same instance group but the backends have incompatible balancing_mode. Values should be the same.`

This happens when you try to use the same backend in two different load
balancers with incompatible balancing modes. For more information, see
[Restrictions and guidance for instance groups](https://cloud.google.com/load-balancing/docs/backend-service#restrictions-and-guidance-for-instance-groups).

---

## Troubleshoot general connectivity issues

### Unexplained 5XX errors

Not all HTTP 5XX errors are generated by the load balancer. To determine if a
5XX response was relayed from a backend or generated by the load balancer proxy,
refer to the `statusDetails` field of the load balancer logs.

- If `statusDetails` is `response_sent_by_backend`, the load balancer is
  relaying the backend's response. Troubleshoot HTTP errors on your backends.
- If `statusDetails` is not `response_sent_by_backend`:
  - Configuration changes can cause brief 502 errors with `statusDetails`
    matching `failed_to_pick_backend`.
  - If errors persist, verify that firewall rules allow health checks and that
    health check traffic reaches your backend VMs.

| `statusDetail` failure message                         | Potential causes and solutions                                                                                                                                                    |
| :----------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `failed_to_connect_to_backend`                         | The load balancer failed to connect to the backend. Ensure the service on the backend is listening on the correct port.                                                           |
| `failed_to_pick_backend`                               | The load balancer could not pick a backend, likely because all backends are unhealthy. Check firewall rules for health checks.                                                    |
| `backend_connection_closed_before_data_sent_to_client` | The backend unexpectedly closed its connection. This can happen if a third-party load balancer has a shorter TCP timeout.                                                         |
| `backend_timeout`                                      | The backend took too long to respond. The backend service timeout might be too low. Also, ensure the backend server's keepalive timeout is greater than 10 minutes (600 seconds). |

### Resolving HTTP 408 errors

If you see HTTP 408 responses with `jsonPayload.statusDetail` of
`client_timed_out`, it means there was insufficient progress while proxying the
request or response. This can be due to client performance issues. Increasing
the backend service timeout may resolve this.

### Load balanced traffic does not have the source address of the original client

Proxy-based load balancers use two TCP connections. The source IP address for
packets seen by the backends is from the load balancer's GFE or proxy-only
subnet, not the original client. See
[Source IP addresses for client packets](https://cloud.google.com/load-balancing/docs/l7-external/l7-xlb-overview#source-ip-addresses)
for details.

### Getting a permission error when trying to view an object in my Cloud Storage bucket

To serve objects via load balancing, Cloud Storage objects must be publicly
accessible. Update their permissions to be publicly readable.

### URL doesn't serve expected Cloud Storage object

The object served is determined by your URL map. If a request path maps to a
backend bucket, the full request path is appended to the bucket name. If
`https://<GCLB IP>/static/path/to/content.jpg` is requested and `/static/*` maps
to `gs://[EXAMPLE_BUCKET]`, the load balancer will try to serve
`gs://[EXAMPLE_BUCKET]/static/path/to/content.jpg`. If it doesn't exist, you'll
get a `NoSuchKey` error.

### Compression isn't working

The load balancer does not compress or decompress responses itself. If responses
are not compressed, ensure your backend web server is configured to do so. Some
web servers disable compression for requests with a `Via` header, which the load
balancer adds. You may need to override this default configuration.

---

## Troubleshoot unhealthy backends

### Troubleshoot issues with HTTP/2 to the backends

- Ensure your backend instance is healthy and supports HTTP/2.
- Verify the VM uses HTTP/2 spec-compliant cipher suites.
- Ensure your firewall allows the health checker and load balancer to pass
  through.
- Ensure the load balancer is configured to talk to the correct port on the VM.

---

## Troubleshoot external backend and internet NEG issues

### Traffic does not reach the endpoints

If traffic cannot reach the endpoint (resulting in a 502 error), query the
`_cloud-eoips.googleusercontent.com` DNS TXT record and ensure the resulting IP
ranges are allowed by your firewall or ACL.

### After configuring an external backend, requests fail with a 5xx error

- Check Logging.
- Verify the NEG is configured with the correct IP:Port or FQDN:Port.
- If using FQDN, ensure it's resolvable via Google Public DNS.
- If your origin web-server expects a hostname, configure a custom `Host`
  request header.
- If communicating over HTTPS or HTTP/2 with an `INTERNET_FQDN_PORT` endpoint,
  ensure the origin presents a valid TLS certificate signed by a public CA and
  the FQDN matches a SAN in the certificate.

### Responses from my external backend are not cached by Cloud CDN

Ensure that:

- You have enabled Cloud CDN on the backend service (`enableCDN: true`).
- Responses from your external backend meet caching requirements (e.g., include
  `Cache-Control: public, max-age=3600` headers).

---

## Troubleshoot serverless NEG issues

### Requests fail with a 404 error

Ensure the underlying serverless resource (App Engine, Cloud Run, etc.) is still
running. The load balancer does not automatically detect if a serverless
resource is deleted or returning errors.

### Handling URL mask mismatches

If a URL mask doesn't result in a valid, existing service name, the load
balancer's behavior depends on the platform:

- **Cloud Run:** Returns an HTTP 404 error.
- **Cloud Functions:** Returns an HTTP 404 error.
- **App Engine:** Uses `dispatch.yaml` and default routing logic to determine
  which service receives the request.
